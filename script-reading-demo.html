<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>剧本朗读演示</title>
    <script src="https://unpkg.com/vue@3.2.45/dist/vue.global.prod.js"></script>
    <script src="./tts.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            background-color: #f5f7fa;
        }
        .container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-weight: 300;
        }
        .script {
            margin-bottom: 20px;
        }
        .line {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 6px;
            background-color: #f0f0f0;
        }
        .character {
            font-weight: bold;
            color: #3498db;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }
        button:hover {
            background-color: #2980b9;
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <h1>剧本朗读演示</h1>
        <div class="script">
            <div v-for="(line, index) in script" :key="index" class="line">
                <span class="character">{{ line.character }}:</span> {{ line.text }}
            </div>
        </div>
        <div class="controls">
            <label>
                <input type="checkbox" v-model="parallelReading" checked> 并行读剧本
            </label>
        </div>
        <button @click="readScript">朗读剧本</button>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted } = Vue;

        createApp({
            setup() {
                const tts = new TTS();
                const voiceConfig = {
                    "旁白": { voice: "zh-CN-YunyangNeural", pitch: -5, rate: 0 },
                    "罗伯特": { voice: "zh-CN-YunxiNeural", pitch: -10, rate: 5 },
                    "图尔斯": { voice: "zh-CN-YunjianNeural", pitch: 0, rate: 5 }
                };
                const script = ref([
                    { character: "旁白", text: "罗伯特蓄势待发，踏上前方，手中的黑色硬木长棍如雷霆般向图尔斯猛击而来，威势逼人。" },
                    { character: "罗伯特", text: "你以为能轻易进入银月寺吗？" },
                    { character: "旁白", text: "这一击似乎要将对方撕裂，挑战着图尔斯的意志。然而，图尔斯的反应却不如罗伯特预期，他的盾牌未能完全挡住这一重击，结果在冲撞中受到冲击，身体向后退去，灵能盾也出现细微的裂痕。" },
                    { character: "旁白", text: "尽管受到攻击，图尔斯没有退缩，迅速调整重心，心中燃起斗志。他高举鳞甲盾，努力稳住身形，随即召唤出锋利的钢铁长剑，剑光一闪，剑身在阳光下闪烁着寒光。" },
                    { character: "图尔斯", text: "罗伯特，我们曾是好友，但今天你只是一道阻碍。无法阻止我完成任务！" },
                    { character: "旁白", text: "然而，他的攻击轨迹被罗伯特的灵能造成了干扰，长剑未能命中目标，反而露出了一丝破绽。" },
                    { character: "旁白", text: "这时，灵能的波动在二人之间弥漫，空气中充满了近乎凝固的紧张。罗伯特在躲避攻击的同时，发现自己敏锐的反应逐渐被敌人的异能所影响，意识到对方的异能并不简单。他趁机向前一步，运用流转的灵能再次调整打击姿态，试图给图尔斯施加压力。图尔斯则在这番失衡中感受到了紧迫感，灵力的消耗让他不得不在心中警惕，战斗的转折似乎就在眼前。" },
                    { character: "旁白", text: "以上是剧本朗读演示，想体验更多精彩的文字剧本游戏吗？快来bb.tobenot.top/main，我们的大模型剧本杀等你来玩！" }
                ]);
                const parallelReading = ref(false);

                async function readScript() {
                    if (parallelReading.value) {
                        await readScriptParallel();
                    } else {
                        await readScriptSequential();
                    }
                }

                async function readScriptSequential() {
                    for (const line of script.value) {
                        await readLine(line);
                    }
                }

                async function readScriptParallel() {
                    const maxConcurrent = 3; // 设置最大并发数量
                    const audioUrls = new Array(script.value.length);
                    const queue = [];

                    for (let i = 0; i < script.value.length; i++) {
                        const line = script.value[i];
                        const promise = getAudioForLine(line).then(url => {
                            audioUrls[i] = url; // 按索引存储生成的音频 URL
                        });
                        queue.push(promise);

                        if (queue.length >= maxConcurrent) {
                            await Promise.race(queue);
                            queue.splice(queue.findIndex(p => p === promise), 1);
                        }
                    }

                    await Promise.all(queue);

                    for (let i = 0; i < audioUrls.length; i++) {
                        // 确保音频 URL 已生成
                        while (!audioUrls[i]) {
                            await new Promise(resolve => setTimeout(resolve, 100)); // 等待音频 URL 生成
                        }
                        await playAudio(audioUrls[i]);
                    }
                }

                function readLine(line) {
                    return new Promise((resolve) => {
                        const config = voiceConfig[line.character];
                        tts.getAudio({
                            text: `${line.text}`,
                            lang: 'zh-CN',
                            voice: tts.getVoiceList('zh-CN').findIndex(v => v.ShortName === config.voice),
                            pitch: config.pitch,
                            rate: config.rate
                        })
                        .then((url) => {
                            const audio = new Audio(url);
                            audio.onended = resolve;
                            audio.play();
                        })
                        .catch((err) => {
                            console.error('播放失败:', err.message);
                            resolve();
                        });
                    });
                }

                function getAudioForLine(line) {
                    const config = voiceConfig[line.character];
                    return tts.getAudio({
                        text: `${line.text}`,
                        lang: 'zh-CN',
                        voice: tts.getVoiceList('zh-CN').findIndex(v => v.ShortName === config.voice),
                        pitch: config.pitch,
                        rate: config.rate
                    });
                }

                function playAudio(url) {
                    return new Promise((resolve) => {
                        const audio = new Audio(url);
                        audio.onended = resolve;
                        audio.play();
                    });
                }

                onMounted(async () => {
                    await tts.fetchVoiceList();
                });

                return {
                    script,
                    readScript,
                    parallelReading
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
